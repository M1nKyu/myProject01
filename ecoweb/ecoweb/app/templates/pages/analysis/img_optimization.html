<!DOCTYPE html>
<html>
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JEP4QKW5CR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JEP4QKW5CR');
    </script>
  	<meta charset="utf-8">
  	<meta name="viewport" content="initial-scale=1, width=device-width">
  	{% if meta %}
      <title>{{ meta.title }}</title>
    {% else %}
      <title>{{ _('imgopt.page_title') }}</title>
    {% endif %}

  	<!-- Open Graph / Social Media Meta Tags -->
    {% include 'includes/meta/meta-tags.html' %}

    <!-- Structured Data (Schema.org JSON-LD) -->
    {% include 'includes/meta/structured-data.html' %}

  	<link rel="stylesheet"  href="{{ url_for('static', filename='css/pages/img_optimization/img_optimization.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/global.css') }}" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/img_optimization/responsive-img.css') }}" />

    <!-- i18n JavaScript Library -->
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
    <script>
        const i18n = new I18n('{{ get_locale() }}');
    </script>
</head>
<body data-task-id="{{ task_id }}">
    <!-- 페이지 로딩 화면 -->
    {% include 'includes/page-loader.html' %}

    <!-- Hidden input for task_id (fallback for older scripts) -->
    <input type="hidden" id="task-id" name="task_id" value="{{ task_id }}">

    {% include 'includes/new-header.html' %}
    {% include 'includes/sidebar.html' %}
  	<div class="img-op">
        {% include 'includes/user-bar.html' %}
        <!-- title -->
        <div class="div1">{{ _('imgopt.main_title') }}</div>

        <!--01. section01 (그래프) ================================================================================ -->
        <div class="img-op-section01 {% if is_already_optimized %}already-optimized{% endif %}">
            <div class="section01-scale-wrapper">
                <div class="img-op-section01-canvas">

                    <div class="img-op-section01-reduction-percent">
                        <div class="reduction-percent-title">{{ _('imgopt.expected_size_title') }}</div>
                        {% if is_already_optimized %}
                        <div class="reduction-percent-value optimized-message">{{ _('imgopt.already_optimized_label') }}</div>
                        <img class="reduction-percent-icon" alt="체크 아이콘" src="{{ url_for('static', filename='img/img_optimization/img-check.svg') }}">
                        {% else %}
                        <div class="reduction-percent-value">{{ '%.1f%%'|format(((1 - (optimized_image_total_bytes / current_image_total_bytes)) * 100) if current_image_total_bytes else 0) }}</div>
                        <img class="reduction-percent-icon" alt="감소 화살표 아이콘" src="{{ url_for('static', filename='img/img_optimization/img-arrow-down.svg') }}">
                        {% endif %}
                    </div>

                    <div class="img-op-section01-reduction-weight">
                        <div class="reduction-weight-title">{{ _('imgopt.expected_reduction') }}</div>
                        <div class="reduction-weight-value">
                            {% if is_already_optimized %}
                            <div class="reduction-weight-value-text">0.00 {{ _('imgopt.co2_per_visit') }}</div>
                            {% else %}
                            <div class="reduction-weight-value-text">{{ '%.2f'|format(co2_saved) }} {{ _('imgopt.co2_per_visit') }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="img-op-section01-graph">
                        {% if not is_already_optimized %}
                        <!-- 일반 감소 그래프: 배경 + 모든 요소 -->
                        <div class="graph-background">
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>

                            <div class="graph-text-01">{{ _('imgopt.current_image_size') }}</div>
                            <div class="graph-text-02">{{ _('imgopt.optimized_image_size') }}</div>
                        </div>

                        <div class="graph-line"></div>
                        <div class="graph-vertical-line-00"></div>
                        <div class="graph-vertical-line-01"></div>
                        <div class="graph-point"></div>
                        <div class="graph-vertical-line-02"></div>
                        <div class="img-op-section01-circle">
                            <div class="img-op-section01-circle-text">{{ '%.1f'|format(((1 - (optimized_image_total_bytes / current_image_total_bytes)) * 100) if current_image_total_bytes else 0) }}%</div>
                        </div>
                        {% else %}
                        <!-- 이미 최적화된 경우: 배경만 표시 (그래프 요소 없음) -->
                        <div class="graph-background">
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                            <div class="graph-horizontal-line"></div>
                        </div>
                        {% endif %}
                    </div>
                </div> <!-- /.img-op-section01-canvas -->
            </div> <!-- /.section01-scale-wrapper -->
        </div>


        <!--02. section02 (캡처) ================================================================================ -->
        <div class="img-op-section02">
            {% if captured_image_path %}
            <div class="img-op-section02-img-container" onclick="openFullImageModal('{{ url_for('main.serve_capture_image', filename=captured_image_path.replace('var/captures/', '')) }}')">
                <img class="img-op-section02-img" src="{{ url_for('main.serve_capture_image', filename=captured_image_path.replace('var/captures/', '')) }}" alt="{{ _('imgopt.captured_website_image') }}">
                <div class="img-op-section02-hover-overlay">
                    <div class="img-op-section02-fullview-text">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                        </svg>
                        {% if get_locale() == 'ko' %}
                        <span>전체보기</span>
                        {% elif get_locale() == 'en' %}
                        <span>View Full</span>
                        {% elif get_locale() == 'ja' %}
                        <span>全体表示</span>
                        {% elif get_locale() == 'zh' %}
                        <span>查看全部</span>
                        {% else %}
                        <span>전체보기</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <p style="text-align: center; color: white;">{{ _('imgopt.image_load_error') }}</p>
            {% endif %}
            <div class="div9">{{ _('imgopt.high_emission_area') }}</div>
        </div>


        <!--03. section03 ================================================================================ -->
        <div class="img-op-section03">

            <!-- 현재 이미지크기-->
            <div class="section03-item current">
                <div class="section03-value">{{ '%.2f'|format(current_image_total_bytes / (1024*1024)) }}MB</div>
                <div class="section03-title">
                    <p class="p">{{ _('imgopt.current_label') }} </p>
                    <p class="p">{{ _('imgopt.image_size') }}</p>
                </div>
            </div>

            <!-- 최적화 후 이미지크기 -->
            <div class="section03-item optimized">
                <div class="section03-value">{{ '%.2f'|format(optimized_image_total_bytes / (1024*1024)) }}MB</div>
                <div class="section03-title">
                    <p class="p">{{ _('imgopt.optimized_label') }} </p>
                    <p class="p">{{ _('imgopt.image_size') }}</p>
                </div>
            </div>

        </div>

        <!--04. section04 ================================================================================ -->
        <div class="img-op-section04">

            <div class="section04-title">{{ _('imgopt.analysis_title') }}</div>

            <!-- 이미지 총 용량 -->
            <div class="section04-total-image">
                <img class="section04-image-icon" alt="최적화 이전 이미지 아이콘" src="{{ url_for('static', filename='img/img_optimization/img-before.svg') }}">
                <div class="section04-text-wrapper">
                    <div class="section04-text-title">{{ _('imgopt.total_image_capacity') }}</div>
                    <div class="section04-text-value">{{ '%.2f'|format(total_image_resource_bytes / (1024*1024)) }}MB</div>
                    <div class="section04-text-description">{{ _('imgopt.total_image_resource_description') }}</div>
                </div>
            </div>

            <!-- 가능한 이미지 최적화 -->
            <div class="section04-possible-optimization">
                <img class="section04-image-icon" alt="최적화 이후 이미지 아이콘" src="{{ url_for('static', filename='img/img_optimization/img-after.svg') }}">
                <div class="section04-text-wrapper">
                    <div class="section04-text-title">{{ _('imgopt.possible_optimization') }}</div>
                    <div class="section04-text-value">{{ '%.2f'|format((optimization_saved_bytes) / 1024) }}KB</div>
                    <div class="section04-text-description">{{ _('imgopt.webp_conversion_benefit') }}</div>
                </div>
            </div>

        </div>
        
        <!--05. section05 (변환권장이미지 ================================================================================)-->
        <div class="img-op-section05">
            <div class="div15">{{ _('imgopt.format_conversion_list') }}</div>
            <div class="bytes-38">{{ _('imgopt.total_bytes_count', bytes=eligible_original_image_bytes, count=filecount) }}</div>
            <div class="group-parent">
                {% for file in files %}
                <div class="rectangle-parent">
                    <div class="group-child">
                        <img loading="lazy" src="{{ url_for('main.serve_image_file', filename=file.url.replace('var/optimization_images/', '')) if file.url.startswith('var/optimization_images/') else url_for('static', filename=file.url) }}" alt="변환 권장 이미지: {{ file.name }}">
                    </div>
                    <div class="div17" title="{{ file.name }}">{{ file.name }}</div>
                    <div class="bytes">{{ file.size }} bytes</div>
                    <div class="div18">
                        <div class="div19">
                            {% if file.name is defined %}
                                {% set filename_parts = file.name.split('.') %}
                                {% if filename_parts|length > 1 %}
                                    {{ filename_parts[-1]|upper }}
                                {% else %}
                                    {{ _('imgopt.category_other') }}
                                {% endif %}
                            {% else %}
                                {{ _('imgopt.category_other') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!--06. section06 (변환된이미지) ================================================================================ -->
        <div class="img-op-section06">

            <div class="div16">{{ _('imgopt.converted_image_list') }}</div>
            <div class="bytes-39">{{ _('imgopt.total_bytes_count', bytes=webp_total_size, count=convertedfiles|length) }}</div>

            <div class="div55" onclick="downloadWebpFiles()" style="cursor: pointer;">
                <div class="icround-download-parent2">
                    <img class="icround-download-icon5" alt="다운로드 아이콘" src="{{ url_for('static', filename='img/img_optimization/img-download.svg') }}">
                    <div class="div56">{{ _('imgopt.download_images_zip') }}</div>
                </div>
            </div>
            
            <div class="group-container">
                {% if convertedfiles and convertedfiles|length > 0 %}
                    {% for file in convertedfiles %}
                    <div class="parent">
                        <div class="div35">{{ file['name']|default(file.name|default('unknown')) }}</div>
                        <div class="bytes6">{{ file['original_size']|default(file.original_size|default(0)) }} bytes</div>
                        {% set orig_size = file['original_size']|default(file.original_size|default(0)) %}
                        {% set webp_size = file['size']|default(file.size|default(0)) %}
                        {% if webp_size and orig_size and orig_size > 0 %}
                        <div class="div36">- {{ ((orig_size - webp_size) / orig_size * 100)|round(1) }}%</div>
                        {% endif %}
                        <div class="bytes7">{{ webp_size }} bytes</div>
                        <div class="group-child4">
                            {% set webp_name = file['webp_name']|default(file.webp_name|default(file['name']|default(file.name|default('')))) %}
                            <img class="img-fluid" loading="lazy" src="{{ url_for('main.serve_image_file', filename=url_s + '/webp/' + webp_name) }}" alt="변환된 WebP 이미지: {{ file['name']|default(file.name|default('unknown')) }}">
                        </div>
                        <div class="div37" onclick="downloadSingleWebp('{{ url_s }}', '{{ file['name']|default(file.name|default('unknown')) }}')" style="cursor: pointer;">
                            <div class="icround-download-parent">
                                <img class="icround-download-icon" alt="다운로드 아이콘" src="{{ url_for('static', filename='img/img_optimization/img-download.svg') }}">
                                <div class="div19">{{ _('imgopt.webp_label') }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="parent" style="text-align: center; padding: 20px;">
                        <p>변환된 이미지가 없습니다. (convertedfiles: {{ convertedfiles|length if convertedfiles else 0 }})</p>
                    </div>
                {% endif %}
            </div>  
        </div>

    </div>

  	<script>
    		var container1 = document.getElementById("container1");
    		if(container1) {
      			container1.addEventListener("click", function (e) {
        				// Add your code here
      			});
    		}

    		var container3 = document.getElementById("container3");
    		if(container3) {
      			container3.addEventListener("click", function (e) {
        				// Add your code here
      			});
    		}

    		var container4 = document.getElementById("container4");
    		if(container4) {
      			container4.addEventListener("click", function (e) {
        			// Add your code here
      			});
    		}

    		// Webp 파일 ZIP 다운로드 함수
    		function downloadWebpFiles() {
        		window.location.href = '/download-webp';
    		}

    		// 개별 Webp 파일 다운로드 함수
    		function downloadSingleWebp(url_s, filename) {
        		try {
            		// URL에서 http:// 또는 https:// 제거
            		const cleanUrl = url_s.replace(/^https?:\/\//, '');
            		const downloadUrl = `/download-single-webp/${cleanUrl}/${filename}`;

            		console.log('Download URL:', downloadUrl);  // 디버깅용

            		fetch(downloadUrl)
                		.then(response => {
                    		if (!response.ok) {
                        		throw new Error('Network response was not ok');
                    		}
                    		return response.blob();
                		})
                		.then(blob => {
                    		const url = window.URL.createObjectURL(blob);
                    		const a = document.createElement('a');
                    		a.href = url;
                    		a.download = filename.endsWith('.webp') ? filename : `${filename}.webp`;
                    		document.body.appendChild(a);
                    		a.click();
                    		window.URL.revokeObjectURL(url);
                    		document.body.removeChild(a);
                		})
                		.catch(error => {
                    		console.error('Download error:', error);
                    		alert(i18n.t('imgopt.download_error'));
                		});
        		} catch (error) {
            		console.error('Function error:', error);
            		alert(i18n.t('imgopt.download_error'));
        		}
    		}
    </script>
    
    <!-- Debug: Log all data passed to this template -->
    <script>
      (function() {
        try {
          const pageData = {
            emission_percentile: {{ emission_percentile | default(None) | tojson }},
            files: {{ files | default([]) | tojson }},
            convertedfiles: {{ convertedfiles | default([]) | tojson }},
            totalsize: {{ totalsize | default(0) | tojson }},
            total_downloaded_image_bytes: {{ total_downloaded_image_bytes | default(0) | tojson }},
            eligible_original_image_bytes: {{ eligible_original_image_bytes | default(0) | tojson }},
            filecount: {{ filecount | default(0) | tojson }},
            url_s: {{ url_s | default('') | tojson }},
            category: {{ category | default({}) | tojson }},
            view_data: {{ view_data | default({}) | tojson }},
            captured_image_path: {{ captured_image_path | default('') | tojson }},
            webp_total_size: {{ webp_total_size | default(0) | tojson }},
            co2_saved: {{ co2_saved | default(0) | tojson }}
          };
          // 유도 파생 데이터
          const derived = {
            totalsize_mb: (pageData.totalsize / (1024*1024)),
            eligible_original_image_bytes_mb: (pageData.eligible_original_image_bytes / (1024*1024)),
            saved_bytes: (pageData.eligible_original_image_bytes - pageData.webp_total_size),
            saved_kb: ((pageData.eligible_original_image_bytes - pageData.webp_total_size) / 1024),
            saved_mb: ((pageData.eligible_original_image_bytes - pageData.webp_total_size) / (1024*1024))
          };

          console.group('%c[new-ui/img_optimization] Template Data','color:#0a84ff;font-weight:bold');
          console.log('pageData:', pageData);
          console.log('derived:', derived);
          Object.keys(pageData).forEach(k => console.log(k + ':', pageData[k]));
          if (Array.isArray(pageData.files)) {
            console.group('files');
            console.table(pageData.files);
            console.groupEnd();
          }
          if (Array.isArray(pageData.convertedfiles)) {
            console.group('convertedfiles');
            console.table(pageData.convertedfiles);
            console.groupEnd();
          }
          // JSON 문자열도 함께 출력
          console.log('pageData (json):', JSON.stringify(pageData));
          // 전역 접근을 위해 window에 노출
          window.__IMG_OPT_PAGE_DATA__ = pageData;
          window.__IMG_OPT_DERIVED__ = derived;
          console.groupEnd();
        } catch (e) {
          console.error('[new-ui/img_optimization] Failed to log template data:', e);
        }
      })();
    </script>
    
    <!-- Section01 scaling: keep 1020x580 ratio and fit width by setting CSS var --s dynamically -->
    <script>
      (function() {
        function setSection01Scale() {
          var wrappers = document.querySelectorAll('.img-op-section01 .section01-scale-wrapper');
          if (!wrappers.length) return;
          wrappers.forEach(function(wrap) {
            // available content width (exclude horizontal padding if any)
            var wrapWidth = wrap.clientWidth; // already minus scrollbars and padding content box
            var baseWidth = 1020;
            var s = wrapWidth / baseWidth;
            // clamp between 0.1 and 1 for safety
            if (!isFinite(s) || s <= 0) s = 1;
            s = Math.max(0.1, Math.min(1, s));
            wrap.style.setProperty('--s', String(s));
          });
        }
        // run on load and on resize (throttled)
        var scheduled = false;
        function onResize() {
          if (scheduled) return;
          scheduled = true;
          requestAnimationFrame(function(){
            scheduled = false;
            setSection01Scale();
          });
        }
        window.addEventListener('DOMContentLoaded', setSection01Scale);
        window.addEventListener('load', setSection01Scale);
        window.addEventListener('resize', onResize);
      })();
    </script>

    <!-- Image lazy loading optimization: load images only when they're about to be visible -->
    <script>
      (function() {
        // Check if IntersectionObserver is supported
        if ('IntersectionObserver' in window) {
          // Create observer with root margin to start loading images slightly before they're visible
          var imageObserver = new IntersectionObserver(function(entries, observer) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                var img = entry.target;
                // Only load if src is not already set or if it's a data-src
                if (img.dataset.src) {
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                }
                // Mark as loaded to prevent re-processing
                img.classList.add('img-loaded');
                observer.unobserve(img);
              }
            });
          }, {
            rootMargin: '50px' // Start loading 50px before image enters viewport
          });

          // Observe all lazy-loaded images in group-parent and group-container
          document.addEventListener('DOMContentLoaded', function() {
            var lazyImages = document.querySelectorAll('.group-parent img[loading="lazy"], .group-container img[loading="lazy"]');
            lazyImages.forEach(function(img) {
              // If browser already supports native lazy loading, just observe for optimization
              if ('loading' in HTMLImageElement.prototype) {
                // Native lazy loading is supported, but we can still optimize
                imageObserver.observe(img);
              } else {
                // Fallback: use data-src pattern for browsers without native lazy loading
                if (!img.dataset.src) {
                  img.dataset.src = img.src;
                  img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E'; // Placeholder
                }
                imageObserver.observe(img);
              }
            });
          });
        }
      })();
    </script>

    <!-- Full Image Modal -->
    <div id="fullImageModal" class="full-image-modal">
        <div class="full-image-modal-content">
            <button class="full-image-modal-close" onclick="closeFullImageModal()">&times;</button>
            <img id="fullImageView" src="" alt="{{ _('imgopt.full_captured_image') }}">
        </div>
    </div>

    <script>
        let isFullscreen = false;
        
        function openFullImageModal(imageSrc) {
            const modal = document.getElementById('fullImageModal');
            const img = document.getElementById('fullImageView');
            img.src = imageSrc;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            isFullscreen = false;
        }

        function closeFullImageModal() {
            // 전체화면 모드인 경우 먼저 전체화면 종료
            if (isFullscreen && document.exitFullscreen) {
                document.exitFullscreen();
            } else if (isFullscreen && document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (isFullscreen && document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (isFullscreen && document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            
            const modal = document.getElementById('fullImageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            isFullscreen = false;
        }
        
        function toggleFullscreen() {
            const modal = document.getElementById('fullImageModal');
            const modalContent = modal.querySelector('.full-image-modal-content');
            
            if (!isFullscreen) {
                // 전체화면 모드 진입
                if (modalContent.requestFullscreen) {
                    modalContent.requestFullscreen();
                } else if (modalContent.webkitRequestFullscreen) {
                    modalContent.webkitRequestFullscreen();
                } else if (modalContent.mozRequestFullScreen) {
                    modalContent.mozRequestFullScreen();
                } else if (modalContent.msRequestFullscreen) {
                    modalContent.msRequestFullscreen();
                }
                isFullscreen = true;
            } else {
                // 전체화면 모드 종료
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                isFullscreen = false;
            }
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (isFullscreen) {
                    toggleFullscreen();
                } else {
                    closeFullImageModal();
                }
            }
        });

        // 모달 배경 클릭 시 닫기
        document.getElementById('fullImageModal').addEventListener('click', function(event) {
            if (event.target === this && !isFullscreen) {
                closeFullImageModal();
            }
        });
        
        // 모달 이미지 클릭 시 전체화면 토글
        document.getElementById('fullImageView').addEventListener('click', function(event) {
            event.stopPropagation();
            toggleFullscreen();
        });
        
        // 전체화면 변경 이벤트 감지
        document.addEventListener('fullscreenchange', function() {
            isFullscreen = !!document.fullscreenElement;
        });
        document.addEventListener('webkitfullscreenchange', function() {
            isFullscreen = !!document.webkitFullscreenElement;
        });
        document.addEventListener('mozfullscreenchange', function() {
            isFullscreen = !!document.mozFullScreenElement;
        });
        document.addEventListener('MSFullscreenChange', function() {
            isFullscreen = !!document.msFullscreenElement;
        });
    </script>
    </body>
</html>