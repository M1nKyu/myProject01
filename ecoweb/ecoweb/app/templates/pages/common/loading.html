<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JEP4QKW5CR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JEP4QKW5CR');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('loading.page_title') }}</title>

    <!-- Open Graph / Social Media Meta Tags -->
    {% include 'includes/meta/meta-tags.html' %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" />

    <!-- i18n JavaScript Library -->
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
    <script>
        // Initialize i18n
        const i18n = new I18n('{{ get_locale() }}');
    </script>

    <style>
        .div1 {
            font-size: 22px;
            line-height: 32px;
            color: #878a93;
            text-align: center;
            position: static;
            margin-bottom: 16px; /* parentì™€ì˜ ê°„ê²© 16px (iconê³¼ëŠ” ì•„ë˜ .icon marginìœ¼ë¡œ 25px ë³´ì¥) */
        }
        .url {
            position: relative;
            line-height: 32px;
            font-weight: 600;
            display: inline-block;
            max-width: 560px; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .div2 {
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid #c2c4c8;
            box-sizing: border-box;
            height: 40px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            max-width: 600px; /* container width for URL */
            overflow: hidden;
        }
        .div3 {
            font-size: 32px;
            line-height: 40px;
            font-weight: 600;
            text-align: center;
            position: static;
        }
        .parent {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 24px;
            color: #37383c;
            position: static;
            margin-bottom: 24px;
        }
        .vector-icon {
            width: 36px;
            height: 36px;
            position: relative;
            max-height: 100%;
            display: block;
        }
        .div4 {
            line-height: 28px;
            position: static;
        }
        .row-1,
        .row-2,
        .row-3 {
            display: flex;
            flex-direction: row;
            align-items: center; /* iconê³¼ í…ìŠ¤íŠ¸ ìˆ˜ì§ ì •ë ¬ */
            justify-content: flex-start; /* ì¢Œì¸¡ ì •ë ¬ */
            gap: 24px; /* ì•„ì´ì½˜-í…ìŠ¤íŠ¸ ê°„ê²© í†µì¼ */
            position: static;
            margin: 24px 0; /* ì„¸ í–‰ ëª¨ë‘ ë™ì¼ ìƒí•˜ ê°„ê²© */
        }
        .frame-item {
            width: 36px;
            position: relative;
            border-radius: 50%;
            border: 3.8px solid #c2c4c8;
            box-sizing: border-box;
            height: 36px;
        }
        /* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ (ì§„í–‰ ì¤‘ ì•„ì´ì½˜) */
        @keyframes spin360 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinning { animation: spin360 1.2s linear infinite; }
        .icon {
            width: min(322px, 80vw);
            height: auto;
            max-height: 250px;
            object-fit: contain;
            position: static;
            margin: 0 0 25px; /* div1ê³¼ì˜ ê°„ê²© 25px */
        }
        .div {
            width: 100%;
            position: relative;
            background: linear-gradient(180deg, #daf2e9, #f4f4f5);
            min-height: 100vh;
            overflow: hidden;
            text-align: center;
            font-size: 18px;
            color: #70737c;
            font-family: Roboto, sans-serif;
        }
        /* ìˆ˜ì§ ìŠ¤íƒ: í™”ë©´ ì¤‘ì•™ ì •ë ¬ ë° ë°˜ì‘í˜• ë°°ì¹˜ */
        .stack {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
            max-width: 800px;
            min-height: 0; /* flexbox ìµœì†Œ ë†’ì´ ì œí•œ í•´ì œ */
            padding: 20px;
            box-sizing: border-box;
        }
        .hidden { display: none; }
        /* ì‹¤íŒ¨ ì‹œ í™ˆ ë²„íŠ¼ ë§í¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        #error-actions a { text-decoration: none; color: #37383c; }
        
        /* ê²°ê³¼ ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .result-container {
            max-width: 600px;
            margin: 20px auto 0;
            padding: 16px;
            text-align: center;
        }
        .result-header h3 {
            color: #37383c;
            font-size: 20px;
            margin-bottom: 8px;
        }
        .result-header p {
            color: #70737c;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .result-btn {
            padding: 16px 32px;
            background: #37383c;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
        }
        .result-btn:hover {
            background: #2a2b2f;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìµœì í™” */
        @media (max-height: 700px) {
            .stack {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                margin: 20px auto;
                padding: 10px;
            }
            .div {
                min-height: auto;
                padding: 20px 0;
            }
            .icon {
                width: min(250px, 70vw);
                max-height: 180px;
                margin: 0 0 15px;
            }
            .row-1, .row-2, .row-3 {
                margin: 16px 0;
            }
        }

        @media (max-width: 480px) {
            .div3 {
                font-size: 24px;
                line-height: 32px;
            }
            .div1 {
                font-size: 18px;
                line-height: 28px;
            }
            .parent {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 16px;
            }
            .div2 {
                max-width: 90%;
                padding: 6px 10px;
            }
            .row-1, .row-2, .row-3 {
                gap: 16px;
                margin: 12px 0;
            }
            .vector-icon {
                width: 28px;
                height: 28px;
            }
            .frame-item {
                width: 28px;
                height: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="div">
        <div class="stack">
            <img class="icon" alt="" src="{{ url_for('static', filename='img/loading/loading-big.svg') }}">

            <div class="div1" id="status-text">{{ _('loading.please_wait') }}...</div>
            <div class="parent">
                <div class="div2">
                    <div class="url" id="url-text"></div>
                </div>
                <div class="div3">{{ _('loading.analyzing_url') }}</div>
            </div>

            <!-- ì‹¤íŒ¨ ì‹œ í‘œì‹œë  ì•¡ì…˜ ì˜ì—­: .div2 ìŠ¤íƒ€ì¼ ë²„íŠ¼ìœ¼ë¡œ í™ˆ ì´ë™ -->
            <div id="error-actions" class="hidden" aria-live="polite">
                <a href="{{ url_for('main.home') }}" class="div2" id="go-home-btn">{{ _('loading.go_home') }}</a>
            </div>

            <div class="row-1" id="row-1">
                <img class="vector-icon" id="icon-1" alt="" src="{{ url_for('static', filename='img/loading/loading-wait.svg') }}">
                <div class="div4" id="text-1">{{ _('loading.analyzing_main_page') }}</div>
            </div>
            <div class="row-2" id="row-2">
                <img class="vector-icon" id="icon-2" alt="" src="{{ url_for('static', filename='img/loading/loading-wait.svg') }}">
                <div class="div4" id="text-2">{{ _('loading.analyzing_subpages') }}</div>
            </div>
            <div class="row-3" id="row-3">
                <img class="vector-icon" id="icon-3" alt="" src="{{ url_for('static', filename='img/loading/loading-wait.svg') }}">
                <div class="div4" id="text-3">{{ _('loading.optimizing_images') }}</div>
            </div>

            <!-- ì„¤ë¬¸ì¡°ì‚¬ ì˜ì—­ (AJAXë¡œ ë¡œë“œ) -->
            <div id="survey-section" class="hidden"></div>

            <!-- ì¸¡ì • ì™„ë£Œ í›„ ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ -->
            <div id="result-ready" class="result-container hidden">
                <button id="view-results" class="result-btn hidden">{{ _('loading.view_results') }}</button>
            </div>

            <!-- ë””ë²„ê¹…ìš© ì·¨ì†Œ ë²„íŠ¼ (ìˆ¨ê¹€) -->
            <div style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">
                <button id="debug-cancel" style="background: red; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    ğŸš« Debug Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlValue = "{{ url|safe }}";
            const taskId = "{{ task_id|safe }}";
            const statusText = document.getElementById('status-text');
            const urlText = document.getElementById('url-text');
            const icon1 = document.getElementById('icon-1');
            const icon2 = document.getElementById('icon-2');
            const icon3 = document.getElementById('icon-3');
            const text1 = document.getElementById('text-1');
            const text2 = document.getElementById('text-2');
            const text3 = document.getElementById('text-3');

            const ICON_WAIT = "{{ url_for('static', filename='img/loading/loading-wait.svg') }}";
            const ICON_PROGRESS = "{{ url_for('static', filename='img/loading/loading-in-progress.svg') }}";
            const ICON_DONE = "{{ url_for('static', filename='img/loading/loading-done.svg') }}";

            // URL í‘œì‹œ
            urlText.textContent = urlValue || '';
            if (urlValue) {
                urlText.setAttribute('title', urlValue);
            } else {
                urlText.removeAttribute('title');
            }

            let intervalId;
            let surveyStarted = false;
            let surveyCompleted = false;
            let surveyData = {};
            let measurementComplete = false;
            // ë™ì  ë‹¨ê³„ êµ¬ì„±: 1(ì ‘ì†ê²½ë¡œ),2(ì§êµ°),3(ìš´ì˜ì—¬ë¶€),4(ë°©ë¬¸ì),5(ìœ í˜•),6(ê°ì‚¬ì¸ì‚¬/ì´ë©”ì¼)
            let visibleSteps = [1,2,3,4,5,6];
            let currentStepIndex = 0; // 0-based index into visibleSteps

            // ê°„ë‹¨í•œ fetch ì¬ì‹œë„ ìœ í‹¸
            function fetchWithRetry(url, options = {}, retries = 3, delayMs = 1000) {
                return new Promise((resolve, reject) => {
                    const attempt = (n) => {
                        fetch(url, options)
                            .then(res => {
                                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                                resolve(res);
                            })
                            .catch(err => {
                                if (n > 0) {
                                    console.warn(`fetch retry (${retries - n + 1}) for`, url, 'after error:', err);
                                    setTimeout(() => attempt(n - 1), delayMs);
                                } else {
                                    reject(err);
                                }
                            });
                    };
                    attempt(retries);
                });
            }

            function setIcon(el, src, spinning=false) {
                el.src = src;
                if (spinning) el.classList.add('spinning'); else el.classList.remove('spinning');
            }

            function setIconByStep(el, stepStatus) {
                switch (stepStatus) {
                    case 'in_progress':
                        setIcon(el, ICON_PROGRESS, true);
                        break;
                    case 'done':
                        setIcon(el, ICON_DONE, false);
                        break;
                    case 'waiting':
                    default:
                        setIcon(el, ICON_WAIT, false);
                        break;
                }
            }

            function checkStatus() {
                fetch(`/check_status/${taskId}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.debug('[check_status]', new Date().toISOString(), data);
                        const status = data.status;
                        const normStatus = (status || '').toString().trim().toUpperCase();
                        const progress = data.progress || {};
                        const steps = (progress.steps) || {};
                        const inputStep = steps.input || {};
                        const subpagesStep = steps.subpages || {};
                        const imageOptStep = steps.image_opt || {};
                        // Phase 2 ìˆ˜ì •: SUCCESSë„ ì™„ë£Œ ìƒíƒœë¡œ ì²˜ë¦¬ (Celery ì™„ë£Œ ìƒíƒœ)
                        if (normStatus === 'SUCCESS' || normStatus === 'MEASUREMENT_COMPLETE') {
                            clearInterval(intervalId);
                            statusText.textContent = i18n.t('loading.analysis_complete');
                            // ë‘ ë‹¨ê³„ ëª¨ë‘ ì™„ë£Œ ì²˜ë¦¬
                            setIconByStep(icon1, 'done');
                            setIconByStep(icon2, 'done');
                            setIconByStep(icon3, 'done');

                            // ê²°ê³¼ê°€ DBì— í™•ì‹¤íˆ ì €ì¥ë˜ì—ˆëŠ”ì§€ ì¶”ê°€ í™•ì¸ (1ì´ˆ ëŒ€ê¸° - Phase 2 ìˆ˜ì •)
                            setTimeout(() => {
                                // ì„¤ë¬¸ì¡°ì‚¬ê°€ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì‹œì‘
                                if (!surveyStarted) {
                                    showSurvey();
                                }
                                // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
                                showResultReady();
                            }, 1000);
                        } else if (normStatus === 'QUEUED') {
                            statusText.textContent = i18n.t('loading.queued_message', {position: data.queue_position});
                            // ëª¨ë‘ ëŒ€ê¸° ìƒíƒœ
                            setIconByStep(icon1, 'waiting');
                            setIconByStep(icon2, 'waiting');
                            setIconByStep(icon3, 'waiting');
                        } else if (normStatus === 'PENDING' || normStatus === 'STARTED' || normStatus === 'PROGRESS') {
                            statusText.textContent = i18n.t('loading.in_progress');
                            // ë””ë²„ê·¸: í˜„ì¬ ì„¸ë¶€ ë‹¨ê³„ ë¡œê·¸ ë‚¨ê¸°ê¸°
                            console.debug('[progress]', {
                                input: inputStep.status,
                                subpages: subpagesStep.status,
                                image_opt: imageOptStep.status
                            });
                            // ìƒì„¸ ë‹¨ê³„ ì •ë³´ê°€ ìˆìœ¼ë©´ ë°˜ì˜, ì—†ìœ¼ë©´ ê¸°ë³¸ ê·œì¹™ ì ìš©
                            if (inputStep.status || subpagesStep.status || imageOptStep.status) {
                                setIconByStep(icon1, inputStep.status || 'waiting');
                                setIconByStep(icon2, subpagesStep.status || 'waiting');
                                setIconByStep(icon3, imageOptStep.status || 'waiting');
                            } else {
                                // ê¸°ë³¸: 1ë‹¨ê³„ ì§„í–‰, 2ë‹¨ê³„ ëŒ€ê¸°
                                setIconByStep(icon1, 'in_progress');
                                setIconByStep(icon2, 'waiting');
                                setIconByStep(icon3, 'waiting');
                            }
                            // Fallback: ëª¨ë“  ì„¸ë¶€ ë‹¨ê³„ê°€ doneì´ë©´ ì™„ë£Œë¡œ ì²˜ë¦¬
                            const allDone = [inputStep.status, subpagesStep.status, imageOptStep.status]
                                .every(s => (s || '').toString().toLowerCase() === 'done');
                            if (allDone) {
                                clearInterval(intervalId);
                                statusText.textContent = i18n.t('loading.analysis_complete');
                                setIconByStep(icon1, 'done');
                                setIconByStep(icon2, 'done');
                                setIconByStep(icon3, 'done');

                                // ê²°ê³¼ê°€ DBì— í™•ì‹¤íˆ ì €ì¥ë˜ì—ˆëŠ”ì§€ ì¶”ê°€ í™•ì¸ (1ì´ˆ ëŒ€ê¸° - Phase 2 ìˆ˜ì •)
                                setTimeout(() => {
                                    if (!surveyStarted) {
                                        showSurvey();
                                    }
                                    showResultReady();
                                }, 1000);
                            }
                        } else if (status === 'CANCELLED') {
                            clearInterval(intervalId);
                            taskCancelled = true;

                            statusText.innerHTML = `
                                <div style="color: #f39c12; font-weight: 600; margin-bottom: 8px;">
                                    ${i18n.t('loading.cancelled_title')}
                                </div>
                                <div style="margin-bottom: 12px;">
                                    ${i18n.t('loading.cancelled_message')}
                                </div>
                            `;

                            // ëª¨ë“  ì•„ì´ì½˜ì„ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •
                            setIconByStep(icon1, 'waiting');
                            setIconByStep(icon2, 'waiting');
                            setIconByStep(icon3, 'waiting');

                            // ì‹¤íŒ¨ ì‹œ URL í‘œì‹œ ë¸”ë¡ ìˆ¨ê¸°ê³  í™ˆ ë²„íŠ¼ ë…¸ì¶œ
                            const parentBlock = document.querySelector('.parent');
                            const errorActions = document.getElementById('error-actions');
                            if (parentBlock) parentBlock.classList.add('hidden');
                            if (errorActions) {
                                errorActions.innerHTML = `
                                    <a href="/" class="div2" style="text-decoration: none; color: #37383c; cursor: pointer;" onclick="taskCancelled = true;">${i18n.t('loading.new_analysis')}</a>
                                `;
                                errorActions.classList.remove('hidden');
                            }
                        } else if (status === 'FAILURE') {
                            clearInterval(intervalId);

                            // ì˜¤ë¥˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ í‘œì‹œ
                            if (data.error_info && data.error_info.title) {
                                // ì ‘ê·¼ì„± ì²´í¬ ì‹¤íŒ¨ì¸ ê²½ìš° ë” ê°„ë‹¨í•œ ë©”ì‹œì§€
                                if (data.error_info.title.includes('ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                                    statusText.innerHTML = `
                                        <div style="color: #e74c3c; font-weight: 600; margin-bottom: 8px;">
                                            ${data.error_info.title}
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            ${data.error_info.message}
                                        </div>
                                        <div style="font-size: 16px; color: #7f8c8d; line-height: 1.4;">
                                            ğŸ’¡ ${data.error_info.suggestion}
                                        </div>
                                    `;
                                } else {
                                    // ì¼ë°˜ ì˜¤ë¥˜ì˜ ê²½ìš° URL ë§í¬ í¬í•¨
                                    statusText.innerHTML = `
                                        <div style="color: #e74c3c; font-weight: 600; margin-bottom: 8px;">
                                            ${data.error_info.title}
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            ${data.error_info.message}
                                        </div>
                                        <div style="font-size: 16px; color: #7f8c8d; line-height: 1.4;">
                                            ğŸ’¡ ${data.error_info.suggestion}<br>
                                            ğŸ” í•´ë‹¹ ì‚¬ì´íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ ì§ì ‘ í™•ì¸í•´ ë³´ì„¸ìš”:
                                            <a href="${urlValue}" target="_blank" rel="noopener noreferrer"
                                               style="color: #3498db; text-decoration: underline; font-weight: 500;">
                                                ${urlValue}
                                            </a>
                                        </div>
                                    `;
                                }
                            } else {
                                statusText.innerHTML = `
                                    <div style="color: #e74c3c; font-weight: 600; margin-bottom: 8px;">
                                        ${i18n.t('loading.failure_title')}
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        ${i18n.t('loading.failure_message')}
                                    </div>
                                    <div style="font-size: 16px; color: #7f8c8d; line-height: 1.4;">
                                        ğŸ’¡ ${i18n.t('loading.failure_suggestion')}<br>
                                        ğŸ” ${i18n.t('loading.check_site_status')}:
                                        <a href="${urlValue}" target="_blank" rel="noopener noreferrer"
                                           style="color: #3498db; text-decoration: underline; font-weight: 500;">
                                            ${urlValue}
                                        </a>
                                    </div>
                                `;
                            }

                            // ì‹¤íŒ¨ ì‹œ: ì§„í–‰ ë‹¨ê³„ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ìƒíƒœ ìœ ì§€, ì—†ìœ¼ë©´ ëŒ€ê¸° ì•„ì´ì½˜
                            if (inputStep.status || subpagesStep.status || imageOptStep.status) {
                                setIconByStep(icon1, inputStep.status || 'waiting');
                                setIconByStep(icon2, subpagesStep.status || 'waiting');
                                setIconByStep(icon3, imageOptStep.status || 'waiting');
                            } else {
                                setIconByStep(icon1, 'waiting');
                                setIconByStep(icon2, 'waiting');
                                setIconByStep(icon3, 'waiting');
                            }
                            // ì‹¤íŒ¨ ì‹œ URL í‘œì‹œ ë¸”ë¡ ìˆ¨ê¸°ê³  ì ì ˆí•œ ë²„íŠ¼ ë…¸ì¶œ
                            const parentBlock = document.querySelector('.parent');
                            const errorActions = document.getElementById('error-actions');
                            if (parentBlock) parentBlock.classList.add('hidden');
                            if (errorActions) {
                                // ì ‘ê·¼ì„± ì²´í¬ ì‹¤íŒ¨ì¸ ê²½ìš° ë‹¤ì‹œ ì‹œë„ ë²„íŠ¼ë„ í•¨ê»˜ í‘œì‹œ
                                if (data.error_info && data.error_info.title && data.error_info.title.includes('ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                                    errorActions.innerHTML = `
                                        <div style="display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; margin-top: 16px;">
                                            <a href="/" class="div2" style="text-decoration: none; color: #37383c; cursor: pointer;" onclick="taskCancelled = true;">${i18n.t('loading.enter_different_url')}</a>
                                            <a href="${urlValue}" target="_blank" rel="noopener noreferrer" class="div2" style="text-decoration: none; color: #37383c; cursor: pointer;">${i18n.t('loading.check_site_directly')}</a>
                                        </div>
                                    `;
                                } else {
                                    // ì¼ë°˜ ì‹¤íŒ¨ì˜ ê²½ìš° ê¸°ë³¸ í™ˆ ë²„íŠ¼ë§Œ í‘œì‹œ
                                    errorActions.innerHTML = `
                                        <a href="/" class="div2" style="text-decoration: none; color: #37383c; cursor: pointer;" onclick="taskCancelled = true;">${i18n.t('loading.go_home')}</a>
                                    `;
                                }
                                errorActions.classList.remove('hidden');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching task status:', error);
                        clearInterval(intervalId);
                        statusText.textContent = 'ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                    });
            }

            function showResultReady() {
                measurementComplete = true;
                const ready = document.getElementById('result-ready');
                if (ready) ready.classList.remove('hidden');
                const viewBtn = document.getElementById('view-results');
                if (viewBtn) viewBtn.classList.remove('hidden');
                // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œ CTA ìƒíƒœ ê°±ì‹ 
                updateFinalCTA();
            }

            // ì„¤ë¬¸ì¡°ì‚¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
            function showSurvey() {
                if (surveyStarted) return;
                
                // ë¨¼ì € ì‚¬ìš©ìì˜ ì„¤ë¬¸ì¡°ì‚¬ ì™„ë£Œ ìƒíƒœ í™•ì¸
                fetch('/check_survey_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.has_completed_survey) {
                            // ì´ë¯¸ ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì™„ë£Œí–ˆê±°ë‚˜ ê±´ë„ˆë›´ ê²½ìš°
                            console.log('ì‚¬ìš©ìê°€ ì´ë¯¸ ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.');
                            surveyCompleted = true;
                            document.getElementById('view-results').classList.remove('hidden');
                            return;
                        }
                        
                        // ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì™„ë£Œí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ í‘œì‹œ
                        surveyStarted = true;
                        
                        // AJAXë¡œ HTML fragment ë¡œë“œ (ì—°ê²° ë¦¬ì…‹ ë“± ì¼ì‹œì  ì˜¤ë¥˜ ëŒ€ë¹„ ì¬ì‹œë„)
                        fetchWithRetry('/survey_fragment', {}, 3, 1200)
                    .then(response => response.text())
                    .then(html => {
                        const surveySection = document.getElementById('survey-section');
                        surveySection.innerHTML = html;
                        surveySection.classList.remove('hidden');
                        
                        // fragment ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                        setupSurveyEventListeners();
                        // ì§„í–‰ ë§‰ëŒ€ ë™ì  ìƒì„± ë° ì´ˆê¸°í™”
                        buildProgressBars(visibleSteps.length);
                        showOnlyCurrentStep();
                        updateProgress(currentStepIndex + 1);
                        updateStepLabel(currentStepIndex + 1, visibleSteps.length);
                        updateButtonVisibility();
                        updateFinalCTA();
                if (surveyCompleted) {
                    document.getElementById('view-results').classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Survey fragment load error:', error);
                // ì‹¤íŒ¨ ì‹œì—ëŠ” ì¡°ìš©íˆ ì¬ì‹œë„ ì˜ˆì•½ (ìµœëŒ€ 1íšŒ ì¶”ê°€)
                setTimeout(() => {
                    fetchWithRetry('/survey_fragment', {}, 1, 1500)
                        .then(r => r.text())
                        .then(html2 => {
                            const surveySection = document.getElementById('survey-section');
                            surveySection.innerHTML = html2;
                            surveySection.classList.remove('hidden');
                            setupSurveyEventListeners();
                            buildProgressBars(visibleSteps.length);
                            showOnlyCurrentStep();
                            updateProgress(currentStepIndex + 1);
                            updateStepLabel(currentStepIndex + 1, visibleSteps.length);
                            updateButtonVisibility();
                            updateFinalCTA();
                        })
                        .catch(err2 => {
                            console.error('Survey fragment second attempt failed:', err2);
                            // ìµœì¢… ì‹¤íŒ¨ ì‹œ ì„¤ë¬¸ì¡°ì‚¬ ì™„ë£Œë¡œ ì²˜ë¦¬
                            surveyCompleted = true;
                            if (measurementComplete) {
                                document.getElementById('view-results').classList.remove('hidden');
                            }
                        });
                }, 1500);
            });
                    })
                    .catch(error => {
                        console.error('ì„¤ë¬¸ì¡°ì‚¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                        // ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ ì‹œì—ë„ ì„¤ë¬¸ì¡°ì‚¬ í‘œì‹œ
                        surveyStarted = true;
                        
                        fetchWithRetry('/survey_fragment', {}, 3, 1200)
                            .then(response => response.text())
                            .then(html => {
                                const surveySection = document.getElementById('survey-section');
                                surveySection.innerHTML = html;
                                surveySection.classList.remove('hidden');
                                setupSurveyEventListeners();
                                buildProgressBars(visibleSteps.length);
                                showOnlyCurrentStep();
                                updateProgress(currentStepIndex + 1);
                                updateStepLabel(currentStepIndex + 1, visibleSteps.length);
                                updateButtonVisibility();
                                updateFinalCTA();
                            })
                            .catch(err => console.error('Survey fragment load error:', err));
                    });
            }

            function nextQuestion() {
                const currentStep = visibleSteps[currentStepIndex];
                const currentQ = document.getElementById(`question-${currentStep}`);
                // ë‹¨ê³„ë³„ ë°ì´í„° ìˆ˜ì§‘ ë° ìµœì†Œ ì„ íƒ ì²´í¬
                if (!collectStepData(currentStep)) {
                    alert('ë‹µë³€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                // owner ì‘ë‹µì— ë”°ë¼ visibleSteps ì¬êµ¬ì„± (í•œ ë²ˆë§Œ ì ìš©)
                if (currentStep === 3) {
                    const owner = (surveyData.step2 || {}).owner;
                    if (owner === 'yes') {
                        visibleSteps = [1,2,3,4,5,6];
                    } else {
                        visibleSteps = [1,2,3,6];
                    }
                    buildProgressBars(visibleSteps.length);
                }
                // ë‹¤ìŒ ì¸ë±ìŠ¤ë¡œ ì´ë™
                currentStepIndex++;
                if (currentStepIndex >= visibleSteps.length) {
                    // ë§ˆì§€ë§‰ì„ ì§€ë‚˜ë©´ ì™„ë£Œ ë²„íŠ¼ ë¡œì§ìœ¼ë¡œ ìœ ë„
                    currentStepIndex = visibleSteps.length - 1;
                }
                showOnlyCurrentStepWithAnimation('next');
                updateButtonVisibility();
                updateProgress(currentStepIndex + 1);
                updateStepLabel(currentStepIndex + 1, visibleSteps.length);
                updateFinalCTA();
            }

            function prevQuestion() {
                // ì´ì „ ì¸ë±ìŠ¤ë¡œ ì´ë™
                if (currentStepIndex > 0) {
                    currentStepIndex--;
                }
                showOnlyCurrentStepWithAnimation('prev');
                updateButtonVisibility();
                updateProgress(currentStepIndex + 1);
                updateStepLabel(currentStepIndex + 1, visibleSteps.length);
                updateFinalCTA();
            }

            function updateButtonVisibility() {
                const nextBtn = document.getElementById('survey-next');
                const prevBtn = document.getElementById('survey-prev');
                const completeBtn = document.getElementById('survey-complete');

                if (currentStepIndex === visibleSteps.length - 1) {
                    // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œ: ëª¨ë“  í•˜ë‹¨ ë²„íŠ¼ ìˆ¨ê¹€
                    if (nextBtn) nextBtn.classList.add('hidden');
                    if (prevBtn) prevBtn.classList.add('hidden');
                    if (completeBtn) completeBtn.classList.add('hidden');
                } else {
                    // ì¤‘ê°„ ìŠ¬ë¼ì´ë“œ
                    if (nextBtn) nextBtn.classList.add('hidden'); // ë‹¤ìŒ ë²„íŠ¼ì€ í•­ìƒ ìˆ¨ê¹€ (ìë™ ì§„í–‰)
                    if (completeBtn) completeBtn.classList.add('hidden');

                    // ì´ì „ ë²„íŠ¼ì€ ì²« ìŠ¬ë¼ì´ë“œê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
                    if (currentStepIndex > 0) {
                        if (prevBtn) prevBtn.classList.remove('hidden');
                    } else {
                        if (prevBtn) prevBtn.classList.add('hidden');
                    }
                }
            }

            function completeSurvey() {
                // ë§ˆì§€ë§‰ ë‹¨ê³„ ë°ì´í„° ìˆ˜ì§‘ (ìœ íš¨ì„±ì€ ì„ íƒì )
                const step = visibleSteps[currentStepIndex];
                collectStepData(step);
                surveyCompleted = true;
                // ëª¨ë“  ë§‰ëŒ€ í™œì„±í™” ì²˜ë¦¬
                updateProgress(visibleSteps.length);
                updateStepLabel(visibleSteps.length, visibleSteps.length);

                // ì„¤ë¬¸ ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ API í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
                const surveyPayload = {
                    step1_source: surveyData.step1?.source || null,
                    step2_role: surveyData.step2?.role || null,
                    step2_owner: surveyData.step2?.owner || null,
                    step3_visitors: surveyData.step3?.visitors || null,
                    step3_type: surveyData.step3?.type || null,
                    step4_email: surveyData.step4?.email || null,
                    step7_updates_optin: surveyData.step7?.updates_optin || false,
                    is_completed: true,
                    is_skipped: false
                };

                fetch('/submit_survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(surveyPayload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('ì„¤ë¬¸ì¡°ì‚¬ ì €ì¥ ì™„ë£Œ:', data.message);
                    } else {
                        console.error('ì„¤ë¬¸ì¡°ì‚¬ ì €ì¥ ì‹¤íŒ¨:', data.error);
                    }
                })
                .catch(error => console.error('Survey submission error:', error));

                document.getElementById('survey-section').classList.add('hidden');

                if (measurementComplete) {
                    document.getElementById('view-results').classList.remove('hidden');
                }
            }

            function skipSurvey() {
                surveyCompleted = true;
                
                // ì„¤ë¬¸ì¡°ì‚¬ ê±´ë„ˆë›°ê¸° API í˜¸ì¶œ
                fetch('/skip_survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('ì„¤ë¬¸ì¡°ì‚¬ ê±´ë„ˆë›°ê¸° ì €ì¥ ì™„ë£Œ:', data.message);
                    } else {
                        console.error('ì„¤ë¬¸ì¡°ì‚¬ ê±´ë„ˆë›°ê¸° ì €ì¥ ì‹¤íŒ¨:', data.error);
                    }
                })
                .catch(error => console.error('Survey skip error:', error));
                
                document.getElementById('survey-section').classList.add('hidden');
                
                if (measurementComplete) {
                    document.getElementById('view-results').classList.remove('hidden');
                }
            }

            function finishSurvey() {
                // ë§ˆì§€ë§‰ ë‹¨ê³„ ë°ì´í„° ìˆ˜ì§‘ (6ë‹¨ê³„ ì´ë©”ì¼ ë° ì—…ë°ì´íŠ¸ ìˆ˜ì‹  ë™ì˜)
                collectStepData(6);
                surveyCompleted = true;

                // ì„¤ë¬¸ ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ API í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
                const surveyPayload = {
                    step1_source: surveyData.step1?.source || null,
                    step2_role: surveyData.step2?.role || null,
                    step2_owner: surveyData.step2?.owner || null,
                    step3_visitors: surveyData.step3?.visitors || null,
                    step3_type: surveyData.step3?.type || null,
                    step4_email: surveyData.step4?.email || null,
                    step7_updates_optin: surveyData.step7?.updates_optin || false,
                    is_completed: true,
                    is_skipped: false
                };

                fetch('/submit_survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(surveyPayload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('ì„¤ë¬¸ì¡°ì‚¬ ì €ì¥ ì™„ë£Œ:', data.message);
                    } else {
                        console.error('ì„¤ë¬¸ì¡°ì‚¬ ì €ì¥ ì‹¤íŒ¨:', data.error);
                    }
                })
                .catch(error => console.error('Survey submission error:', error));

                // ì„¤ë¬¸ì¡°ì‚¬ ì°½ ë‹«ê¸°
                document.getElementById('survey-section').classList.add('hidden');
                
                if (measurementComplete) {
                    document.getElementById('view-results').classList.remove('hidden');
                }
            }

            function viewResults() {
                // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•˜ê¸° ì „ì— í•œ ë²ˆ ë” ìƒíƒœ í™•ì¸
                fetch(`/check_status/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        const status = (data.status || '').toString().trim().toUpperCase();

                        // í™•ì‹¤íˆ ì™„ë£Œëœ ìƒíƒœì¸ì§€ í™•ì¸
                        if (status === 'SUCCESS' || status === 'MEASUREMENT_COMPLETE') {
                            // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•  ë•ŒëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ
                            taskCancelled = true;
                            window.location.href = `/carbon_calculate_emission/${taskId}`;
                        } else {
                            // ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                            alert(i18n.t('loading.please_wait_completion'));
                            console.warn('[viewResults] Task not ready yet. Status:', status);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking final status:', error);
                        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì´ë™ ì‹œë„ (fallback)
                        taskCancelled = true;
                        window.location.href = `/carbon_calculate_emission/${taskId}`;
                    });
            }

            // ì„¤ë¬¸ì¡°ì‚¬ fragment ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            function setupSurveyEventListeners() {
                const nextBtn = document.getElementById('survey-next');
                const prevBtn = document.getElementById('survey-prev');
                const completeBtn = document.getElementById('survey-complete');
                const skipBtn = document.getElementById('survey-skip');
                const skipBtnBottom = document.getElementById('survey-skip-bottom');
                const finishBtn = document.getElementById('survey-finish');

                if (nextBtn) nextBtn.addEventListener('click', nextQuestion);
                if (prevBtn) prevBtn.addEventListener('click', prevQuestion);
                if (completeBtn) completeBtn.addEventListener('click', completeSurvey);
                if (skipBtn) skipBtn.addEventListener('click', skipSurvey);
                if (skipBtnBottom) skipBtnBottom.addEventListener('click', skipSurvey);
                if (finishBtn) finishBtn.addEventListener('click', finishSurvey);

                // ë‹¨ì¼ ì„ íƒ ì§ˆë¬¸(radio)ì— ìë™ ì§„í–‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                const radioInputs = document.querySelectorAll('#survey-section input[type="radio"]');
                radioInputs.forEach(radio => {
                    radio.addEventListener('change', function() {
                        // ì§§ì€ ë”œë ˆì´ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™ (ì‚¬ìš©ìê°€ ì„ íƒì„ í™•ì¸í•  ì‹œê°„ ì œê³µ)
                        setTimeout(() => {
                            nextQuestion();
                        }, 400);
                    });
                });
            }

            // ì§„í–‰ ë§‰ëŒ€ ìƒíƒœ ì—…ë°ì´íŠ¸: í˜„ì¬ ì§ˆë¬¸ ë²ˆí˜¸ê¹Œì§€ í™œì„±í™”
            function updateProgress(stepPosition) {
                const bars = document.querySelectorAll('#survey-section .progress-bar');
                if (!bars || bars.length === 0) return;
                bars.forEach((bar, idx) => {
                    if (idx < stepPosition) bar.classList.add('active');
                    else bar.classList.remove('active');
                });
            }

            // ì„¤ë¬¸ ë²ˆí˜¸ ë¼ë²¨ ê°±ì‹  (ì›í˜• ìˆ«ì: â¶..â»), í˜„ì¬ í‘œì‹œ ìœ„ì¹˜ ê¸°ì¤€
            function updateStepLabel(stepPosition, total) {
                const labelEl = document.querySelector('#survey-section #survey-step-label');
                if (!labelEl) return;
                const circled = ['â¶', 'â·', 'â¸', 'â¹', 'âº', 'â»'];
                const text = circled[stepPosition - 1] || `${stepPosition}`;
                labelEl.textContent = text;
            }

            // ë‹¨ê³„ë³„ ë°ì´í„° ìˆ˜ì§‘/ê²€ì¦
            function collectStepData(step) {
                const root = document.getElementById('survey-section');
                if (!root) return true;
                switch (step) {
                    case 1: {
                        const sourceEl = root.querySelector('input[name="step1_source"]:checked');
                        const source = sourceEl ? sourceEl.value : null;
                        if (!source) return false; // í•„ìˆ˜
                        surveyData.step1 = { source };
                        return true;
                    }
                    case 2: {
                        const roleEl = root.querySelector('input[name="step2_role"]:checked');
                        const role = roleEl ? roleEl.value : null;
                        if (!role) return false; // í•„ìˆ˜
                        surveyData.step2 = { role };
                        return true;
                    }
                    case 3: {
                        const ownerEl = root.querySelector('input[name="step2_owner"]:checked');
                        const owner = ownerEl ? ownerEl.value : null;
                        if (!owner) return false; // í•„ìˆ˜
                        surveyData.step2 = Object.assign({}, surveyData.step2 || {}, { owner });
                        return true;
                    }
                    case 4: {
                        // visitors (ì„ íƒ)
                        const visitorsEl = root.querySelector('input[name="step3_visitors"]:checked');
                        const visitors = visitorsEl ? visitorsEl.value : null;
                        surveyData.step3 = Object.assign({}, surveyData.step3 || {}, { visitors });
                        return true;
                    }
                    case 5: {
                        // type (ì„ íƒ)
                        const typeEl = root.querySelector('input[name="step3_type"]:checked');
                        const type = typeEl ? typeEl.value : null;
                        surveyData.step3 = Object.assign({}, surveyData.step3 || {}, { type });
                        return true;
                    }
                    case 6: {
                        // ê°ì‚¬ ì¸ì‚¬ ìŠ¬ë¼ì´ë“œ: ì´ë©”ì¼ ë° ì—…ë°ì´íŠ¸ ìˆ˜ì‹  ë™ì˜ ìˆ˜ì§‘
                        const emailRaw = (root.querySelector('#step4_email') || {}).value || '';
                        const email = emailRaw.trim();
                        const updatesOptIn = !!(root.querySelector('#step7_updates_optin') || {}).checked;
                        surveyData.step4 = { email: email || null };
                        surveyData.step7 = { updates_optin: updatesOptIn };
                        return true;
                    }
                    default:
                        return true;
                }
            }

            function buildProgressBars(count) {
                const container = document.querySelector('#survey-section .progress-bars');
                if (!container) return;
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const div = document.createElement('div');
                    div.className = 'progress-bar';
                    div.dataset.step = String(i + 1);
                    container.appendChild(div);
                }
            }

            function showOnlyCurrentStep() {
                const all = document.querySelectorAll('#survey-section .question');
                all.forEach(q => q.classList.add('hidden'));
                const step = visibleSteps[currentStepIndex];
                const currentQ = document.getElementById(`question-${step}`);
                if (currentQ) currentQ.classList.remove('hidden');

                // ê±´ë„ˆë›°ê¸° ë²„íŠ¼ì€ ì²« ë²ˆì§¸ ìŠ¬ë¼ì´ë“œì—ì„œë§Œ í‘œì‹œ
                const skipBtn = document.getElementById('survey-skip-bottom');
                if (skipBtn) {
                    if (currentStepIndex === 0) {
                        skipBtn.classList.remove('hidden');
                    } else {
                        skipBtn.classList.add('hidden');
                    }
                }
            }

            function showOnlyCurrentStepWithAnimation(direction) {
                const all = document.querySelectorAll('#survey-section .question');
                const prevStep = visibleSteps[direction === 'next' ? currentStepIndex - 1 : currentStepIndex + 1];
                const currentStep = visibleSteps[currentStepIndex];
                const prevQ = document.getElementById(`question-${prevStep}`);
                const currentQ = document.getElementById(`question-${currentStep}`);

                if (!currentQ) {
                    showOnlyCurrentStep();
                    return;
                }

                // ì´ì „ ì§ˆë¬¸ ìŠ¬ë¼ì´ë“œ ì•„ì›ƒ
                if (prevQ && !prevQ.classList.contains('hidden')) {
                    const outClass = direction === 'next' ? 'slide-out-left' : 'slide-out-right';
                    prevQ.classList.add(outClass);

                    setTimeout(() => {
                        prevQ.classList.add('hidden');
                        prevQ.classList.remove(outClass);
                    }, 300);
                }

                // í˜„ì¬ ì§ˆë¬¸ ìŠ¬ë¼ì´ë“œ ì¸
                const inClass = direction === 'next' ? 'slide-in-right' : 'slide-in-left';
                currentQ.classList.remove('hidden');
                currentQ.classList.add(inClass);

                setTimeout(() => {
                    currentQ.classList.remove(inClass);
                }, 300);

                // ë‹¤ë¥¸ ì§ˆë¬¸ë“¤ì€ ìˆ¨ê¹€
                all.forEach(q => {
                    if (q !== prevQ && q !== currentQ) {
                        q.classList.add('hidden');
                    }
                });

                // ê±´ë„ˆë›°ê¸° ë²„íŠ¼ì€ ì²« ë²ˆì§¸ ìŠ¬ë¼ì´ë“œì—ì„œë§Œ í‘œì‹œ
                const skipBtn = document.getElementById('survey-skip-bottom');
                if (skipBtn) {
                    if (currentStepIndex === 0) {
                        skipBtn.classList.remove('hidden');
                    } else {
                        skipBtn.classList.add('hidden');
                    }
                }
            }

            // ë§ˆì§€ë§‰(ê°ì‚¬) ìŠ¬ë¼ì´ë“œ CTA ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            function updateFinalCTA() {
                const cta = document.querySelector('#survey-section #final-cta');
                if (!cta) return;
                // í´ë¦­ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
                const newCta = cta.cloneNode(true);
                cta.parentNode.replaceChild(newCta, cta);
                if (measurementComplete) {
                    newCta.removeAttribute('aria-disabled');
                    newCta.textContent = i18n.t('loading.view_results_button');
                    newCta.addEventListener('click', function() {
                        // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•  ë•ŒëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ
                        taskCancelled = true;
                        viewResults();
                    });
                } else {
                    newCta.setAttribute('aria-disabled', 'true');
                    newCta.textContent = i18n.t('loading.measurement_in_progress');
                }
            }
            
            // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('view-results').addEventListener('click', viewResults);

            // ë””ë²„ê¹…ìš© ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('debug-cancel').addEventListener('click', function() {
                console.log('[DEBUG] Manual cancel button clicked');
                cancelTask();
            });

            // ë¸Œë¼ìš°ì € ë‹«ê¸°/ìƒˆë¡œê³ ì¹¨/í˜ì´ì§€ ì´ë™ ê°ì§€í•˜ì—¬ ì‘ì—… ì·¨ì†Œ ìš”ì²­
            let taskCancelled = false;

            function cancelTask() {
                if (taskCancelled) return;
                taskCancelled = true;

                console.log(`[CANCEL] Attempting to cancel task: ${taskId}`);

                // ì¦‰ì‹œ ì‘ì—… ì·¨ì†Œ ìš”ì²­ ì „ì†¡ (ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì „ì†¡ ë³´ì¥)
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `/cancel_task/${taskId}`, false); // false = ë™ê¸° ìš”ì²­
                xhr.setRequestHeader('Content-Type', 'application/json');
                try {
                    const payload = JSON.stringify({reason: 'client_disconnected'});
                    console.log(`[CANCEL] Sending request to /cancel_task/${taskId} with payload:`, payload);
                    xhr.send(payload);
                    console.log(`[CANCEL] Response status: ${xhr.status}, response: ${xhr.responseText}`);
                } catch (e) {
                    console.log('Task cancellation request failed:', e);
                }
            }

            // beforeunload ì´ë²¤íŠ¸: ë¸Œë¼ìš°ì € ë‹«ê¸°, ìƒˆë¡œê³ ì¹¨, ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™
            window.addEventListener('beforeunload', function(e) {
                // ì¸¡ì • ì™„ë£Œ í›„ì—ëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ (ì •ìƒì ì¸ í˜ì´ì§€ ì´ë™)
                if (!taskCancelled && !measurementComplete) {
                    cancelTask();
                }
            });

            // unload ì´ë²¤íŠ¸: í˜ì´ì§€ê°€ ì™„ì „íˆ ì–¸ë¡œë“œë  ë•Œ
            window.addEventListener('unload', function(e) {
                // ì¸¡ì • ì™„ë£Œ í›„ì—ëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ (ì •ìƒì ì¸ í˜ì´ì§€ ì´ë™)
                if (!taskCancelled && !measurementComplete) {
                    cancelTask();
                }
            });

            // í˜ì´ì§€ ìˆ¨ê¹€ ê°ì§€ (ëª¨ë°”ì¼ì—ì„œ ì•± ì „í™˜ ë“±)
            document.addEventListener('visibilitychange', function() {
                // ì¸¡ì • ì™„ë£Œ í›„ì—ëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ
                if (document.hidden && !taskCancelled && !measurementComplete) {
                    // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì¡Œì„ ë•Œ ì¼ì • ì‹œê°„ í›„ ì·¨ì†Œ (ì¦‰ì‹œ ì·¨ì†Œí•˜ì§€ ì•ŠìŒ)
                    setTimeout(() => {
                        if (document.hidden && !taskCancelled && !measurementComplete) {
                            cancelTask();
                        }
                    }, 30000); // 30ì´ˆ í›„ ì·¨ì†Œ
                }
            });

            // 3ì´ˆ í›„ ì„¤ë¬¸ì¡°ì‚¬ ìë™ ì‹œì‘
            setTimeout(() => {
                if (!surveyStarted && !measurementComplete) {
                    showSurvey();
                }
            }, 3000);

            if (taskId) {
                intervalId = setInterval(checkStatus, 3000);
                checkStatus();
            } else {
                statusText.textContent = 'ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ì‘ì—… IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        });
    </script>
</body>
</html>
